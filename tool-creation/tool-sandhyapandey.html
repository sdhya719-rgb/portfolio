<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced CSV Analyzer</title>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://unpkg.com/@sgratzl/chartjs-chart-boxplot@3.10.0/build/index.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"></script>

    <style>
        :root {
            --primary: #6366f1;
            --sky-blue: #87ceeb;
            --sidebar-gradient: linear-gradient(180deg, #1e1b4b 0%, #0f172a 60%, #1e3a8a 100%);
            --accent-gradient: linear-gradient(135deg, #6366f1 0%, #87ceeb 100%);
            --theme-all: #ef4444; 
            --theme-anom: #10b981; 
            --bg-app: #f3f4f6;
            --surface: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --border: #e5e7eb;
            --anomaly-z: #fee2e2;
            --anomaly-sd: #fef3c7;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', system-ui, sans-serif; background-color: var(--bg-app); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; }

        /* Sidebar */
        #sidebar { width: 300px; background: var(--sidebar-gradient); color: white; display: flex; flex-direction: column; padding: 1.5rem; border-right: 1px solid rgba(135,206,235,0.2); overflow-y: auto; flex-shrink: 0; }
        .brand { font-size: 1.5rem; font-weight: 700; margin-bottom: 2rem; color: white; display: flex; align-items: center; gap: 0.5rem; }
        .sidebar-title { text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; color: var(--sky-blue); margin-bottom: 1rem; font-weight: 600; }
        .control-group { margin-bottom: 1rem; }
        .control-group label { display: block; font-size: 0.875rem; margin-bottom: 0.5rem; color: #c7d2fe; }
        .control-group input, .control-group select { width: 100%; padding: 0.5rem; border-radius: 0.375rem; border: 1px solid #4338ca; background: rgba(255,255,255,0.1); color: white; }
        .btn { display: block; width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: none; font-weight: 600; cursor: pointer; transition: all 0.2s; text-align: center; }
        .btn-primary { background: var(--accent-gradient); color: white; }
        .btn-primary:hover { opacity: 0.9; }
        .upload-area { border: 2px dashed rgba(135,206,235,0.5); border-radius: 0.5rem; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.2s; background: rgba(255,255,255,0.05); }
        .upload-area:hover { border-color: var(--sky-blue); background: rgba(255,255,255,0.1); }

        /* Main Content */
        #main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Navigation Tabs */
        .nav-tabs { display: flex; background: white; border-bottom: 1px solid var(--border); padding: 0 2rem; gap: 2rem; }
        .nav-item { padding: 1.25rem 0; cursor: pointer; color: var(--text-muted); font-weight: 500; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .nav-item:hover { color: var(--primary); }
        .nav-item.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 600; }

        /* Tab Content Area */
        .content-scroll { padding: 2rem; overflow-y: auto; flex: 1; }
        .tab-pane { display: none; animation: fadeIn 0.3s ease; }
        .tab-pane.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Cards & Grid */
        .card { background: var(--surface); border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); padding: 1.5rem; border: 1px solid var(--border); margin-bottom: 1.5rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem; }
        
        /* Stats Specifics */
        .stat-card { background: white; border-radius: 0.75rem; border: 1px solid var(--border); overflow: hidden; }
        .stat-header { padding: 1rem; background: #f9fafb; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-weight: 700; }
        .stat-body { padding: 1rem; font-size: 0.9rem; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        .stat-row b { font-weight: 600; }

        /* Categorical Bars */
        .cat-bar-container { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 0.85rem; }
        .cat-label { width: 100px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .cat-bar-bg { flex: 1; background: #f3f4f6; height: 8px; border-radius: 4px; overflow: hidden; }
        .cat-bar-fill { height: 100%; background: var(--primary); }
        .cat-count { width: 40px; text-align: right; font-weight: 600; }

        /* Table */
        .table-container { overflow: auto; border: 1px solid var(--border); max-height: 600px; border-radius: 0.5rem; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; white-space: nowrap; }
        th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: #f9fafb; position: sticky; top: 0; z-index: 10; cursor: pointer; }
        tr.anomaly-z td { background-color: var(--anomaly-z); }
        tr.anomaly-sd td { background-color: var(--anomaly-sd); }

        /* Utils */
        .hidden { display: none !important; }
        .badge { display: inline-block; padding: 0.25rem 0.5rem; border-radius: 99px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .badge-num { background: #e0e7ff; color: #4338ca; }
        .badge-cat { background: #dcfce7; color: #166534; }
        .badge-date { background: #ffedd5; color: #9a3412; }

        /* Responsive */
        @media (max-width: 768px) { body { flex-direction: column; overflow: auto; } #sidebar { width: 100%; } .nav-tabs { overflow-x: auto; } }
    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <aside id="sidebar">
        <div class="brand"><span>âš¡</span> CSV Pro</div>
        
        <div class="sidebar-title">Data Input</div>
        <div class="upload-area" onclick="document.getElementById('csvInput').click()">
            <input type="file" id="csvInput" accept=".csv" onchange="handleFileUpload(event)" style="display:none">
            <div style="font-size: 2rem;">ðŸ“„</div>
            <div style="font-size: 0.8rem; margin-top:0.5rem;">Click to Upload CSV</div>
        </div>
        <div id="fileNameDisplay" style="font-size: 0.75rem; color: var(--sky-blue); margin: 0.5rem 0 2rem 0; word-break: break-all;"></div>

        <div id="controlsSection" class="hidden">
            <div class="sidebar-title">Anomaly Settings</div>
            <div class="control-group">
                <label>Z-Score Threshold</label>
                <input type="number" id="zThreshold" value="3" step="0.1">
            </div>
            <div class="control-group">
                <label>SD Multiplier</label>
                <input type="number" id="sdThreshold" value="2" step="0.1">
            </div>
            <button class="btn btn-primary" onclick="analyzeData()">Re-Analyze</button>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main id="main-content">
        <!-- Welcome Screen -->
        <div id="welcomeState" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;">
            <h2 style="color: var(--text-muted);">Ready to Analyze</h2>
            <p style="color: var(--text-muted);">Upload a CSV file to generate insights.</p>
        </div>

        <!-- Dashboard (Hidden initially) -->
        <div id="dashboard" class="hidden" style="height: 100%; display: flex; flex-direction: column;">
            
            <!-- Navigation -->
            <nav class="nav-tabs">
                <div class="nav-item active" onclick="switchTab('tab-overview')">Overview & Stats</div>
                <div class="nav-item" onclick="switchTab('tab-categorical')">Categorical</div>
                <div class="nav-item" onclick="switchTab('tab-timeseries')">Time Series & Grouping</div>
                <div class="nav-item" onclick="switchTab('tab-explorer')">Data Explorer</div>
            </nav>

            <div class="content-scroll">
                
                <!-- TAB 1: OVERVIEW & NUMERICAL -->
                <div id="tab-overview" class="tab-pane active">
                    <div class="card" style="display: flex; justify-content: space-around; text-align: center;">
                        <div>
                            <div style="font-size: 0.875rem; color: var(--text-muted);">Total Rows</div>
                            <div style="font-size: 1.5rem; font-weight: 700;" id="sumRows">0</div>
                        </div>
                        <div>
                            <div style="font-size: 0.875rem; color: var(--text-muted);">Columns</div>
                            <div style="font-size: 1.5rem; font-weight: 700;" id="sumCols">0</div>
                        </div>
                        <div>
                            <div style="font-size: 0.875rem; color: var(--text-muted);">Anomaly Rate</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--theme-all);" id="sumRate">0%</div>
                        </div>
                    </div>

                    <h3 style="margin-bottom: 1rem;">Numerical Analysis</h3>
                    <div id="numericGrid" class="stats-grid"></div>
                </div>

                <!-- TAB 2: CATEGORICAL -->
                <div id="tab-categorical" class="tab-pane">
                    <h3 style="margin-bottom: 1rem;">Categorical Distributions</h3>
                    <div id="categoricalGrid" class="stats-grid"></div>
                </div>

                <!-- TAB 3: TIME SERIES & GROUPING -->
                <div id="tab-timeseries" class="tab-pane">
                    <!-- Time Series -->
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                            <h3>Time Series Trends</h3>
                            <select id="timeColSelect" onchange="renderTimeChart()" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border);">
                                <option value="">Select Date Column</option>
                            </select>
                        </div>
                        <canvas id="timeChart" height="80"></canvas>
                        <p id="noTimeMsg" class="hidden" style="text-align: center; color: var(--text-muted); margin-top: 1rem;">No Date/Time columns detected.</p>
                    </div>

                    <!-- Grouping / Pivot -->
                    <div class="card">
                        <h3>Aggregation Tool</h3>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin: 1rem 0; align-items: end;">
                            <div>
                                <label style="font-size: 0.8rem; display: block; margin-bottom: 0.25rem;">Group By (Category)</label>
                                <select id="groupCol" class="control-group" style="color:black; border-color:#ccc; background:white; padding:0.5rem; width: 200px;"></select>
                            </div>
                            <div>
                                <label style="font-size: 0.8rem; display: block; margin-bottom: 0.25rem;">Calculate (Number)</label>
                                <select id="aggCol" style="color:black; border-color:#ccc; padding:0.5rem; width: 200px; border-radius: 4px;"></select>
                            </div>
                            <div>
                                <label style="font-size: 0.8rem; display: block; margin-bottom: 0.25rem;">Operation</label>
                                <select id="aggOp" style="color:black; border-color:#ccc; padding:0.5rem; width: 100px; border-radius: 4px;">
                                    <option value="sum">Sum</option>
                                    <option value="avg">Average</option>
                                    <option value="count">Count</option>
                                    <option value="min">Min</option>
                                    <option value="max">Max</option>
                                </select>
                            </div>
                            <button onclick="calculateGroup()" class="btn btn-primary" style="width: auto; padding: 0.5rem 1.5rem; margin-bottom: 2px;">Calculate</button>
                        </div>
                        <div id="aggResultContainer" class="table-container hidden">
                            <table id="aggTable">
                                <thead><tr><th>Category</th><th>Result</th></tr></thead>
                                <tbody id="aggBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- TAB 4: DATA EXPLORER -->
                <div id="tab-explorer" class="tab-pane">
                    <div class="card">
                        <div style="display:flex; justify-content: space-between; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem;">
                            <div style="display: flex; gap: 0.5rem;">
                                <select id="viewMode" onchange="renderTable()" style="padding:0.5rem; border:1px solid var(--border); border-radius:4px;">
                                    <option value="all">Show All Data</option>
                                    <option value="anomalies">Show Anomalies Only</option>
                                </select>
                                <button onclick="addFilter()" style="padding:0.5rem; background:white; border:1px solid var(--border); border-radius:4px; cursor:pointer;">+ Add Filter</button>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="downloadCSV('full')" style="background: var(--primary); color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Download Full CSV</button>
                                <button onclick="downloadCSV('anomalies')" style="background: var(--theme-all); color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Download Anomalies</button>
                            </div>
                        </div>

                        <div id="activeFilters" style="display:flex; flex-wrap:wrap; gap:0.5rem; margin-bottom:1rem;"></div>
                        
                        <div class="table-container">
                            <table id="dataTable">
                                <thead id="tableHead"></thead>
                                <tbody id="tableBody"></tbody>
                            </table>
                        </div>
                        <div id="rowCountDisplay" style="margin-top:0.5rem; color:var(--text-muted); font-size:0.85rem;"></div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!-- VIZ MODAL -->
    <div id="vizModal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 100; backdrop-filter: blur(2px);" onclick="if(event.target === this) this.classList.add('hidden')">
        <div style="background: white; padding: 2rem; border-radius: 1rem; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div style="display:flex; justify-content:space-between; margin-bottom: 1rem;">
                <h3 id="vizTitle">Visualization</h3>
                <button onclick="document.getElementById('vizModal').classList.add('hidden')" style="border:none; background:none; font-size: 1.5rem; cursor:pointer;">&times;</button>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div><h4 style="font-size:0.9rem; color:var(--text-muted); margin-bottom:0.5rem;">Histogram</h4><canvas id="histCanvas"></canvas></div>
                <div><h4 style="font-size:0.9rem; color:var(--text-muted); margin-bottom:0.5rem;">Box Plot</h4><canvas id="boxCanvas"></canvas></div>
            </div>
        </div>
    </div>

    <script>
        // --- STATE ---
        let rawData = [];
        let headers = [];
        let colTypes = {}; // { colName: 'number' | 'string' | 'date' }
        let stats = {};
        let categoricalStats = {};
        let activeFilters = [];
        let charts = { hist: null, box: null, time: null };

        // --- UI UTILS ---
        const getEl = id => document.getElementById(id);
        const switchTab = (tabId) => {
            document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            getEl(tabId).classList.add('active');
            event.target.classList.add('active');
        };

        // --- FILE HANDLING ---
        function handleFileUpload(e) {
            const file = e.target.files[0];
            if(!file) return;
            getEl('fileNameDisplay').textContent = file.name;
            
            Papa.parse(file, {
                header: true, dynamicTyping: true, skipEmptyLines: true,
                complete: (res) => {
                    rawData = res.data;
                    headers = res.meta.fields;
                    detectTypes();
                    
                    getEl('welcomeState').classList.add('hidden');
                    getEl('dashboard').classList.remove('hidden');
                    getEl('controlsSection').classList.remove('hidden');
                    getEl('main-content').style.display = 'flex'; // Fix layout on load
                    
                    analyzeData();
                }
            });
        }

        // --- ANALYSIS CORE ---
        function detectTypes() {
            // Check first 50 rows to detect type
            headers.forEach(h => {
                let numCount = 0, dateCount = 0, strCount = 0;
                let sample = rawData.slice(0, 50);
                
                sample.forEach(row => {
                    let val = row[h];
                    if(val === null || val === '') return;
                    
                    if(typeof val === 'number') numCount++;
                    // Basic date check (string looks like date and parses)
                    else if(typeof val === 'string' && val.length > 5 && !isNaN(Date.parse(val)) && !/^\d+$/.test(val)) dateCount++;
                    else strCount++;
                });

                if(numCount > strCount && numCount > dateCount) colTypes[h] = 'number';
                else if(dateCount > strCount) colTypes[h] = 'date';
                else colTypes[h] = 'string';
            });
            console.log("Detected Types:", colTypes);
        }

        function analyzeData() {
            const zThresh = parseFloat(getEl('zThreshold').value);
            const sdThresh = parseFloat(getEl('sdThreshold').value);
            
            stats = {}; 
            categoricalStats = {};
            let totalAnomalies = 0;

            // Reset Anomalies
            rawData.forEach(r => r._anomalies = []);

            headers.forEach(col => {
                const type = colTypes[col];
                const values = rawData.map(r => r[col]).filter(v => v !== null && v !== '');

                // 1. Numerical Analysis
                if(type === 'number') {
                    // Basic Stats
                    const n = values.length;
                    const mean = values.reduce((a,b)=>a+b,0)/n;
                    const sorted = [...values].sort((a,b)=>a-b);
                    const median = n%2===0 ? (sorted[n/2-1]+sorted[n/2])/2 : sorted[Math.floor(n/2)];
                    const variance = values.reduce((a,b)=>a+Math.pow(b-mean,2),0)/n;
                    const stdDev = Math.sqrt(variance);

                    stats[col] = { mean, median, min: sorted[0], max: sorted[n-1], stdDev, values };

                    // Detect Anomalies
                    rawData.forEach(row => {
                        const val = row[col];
                        if(typeof val !== 'number') return;
                        if(Math.abs((val - mean)/stdDev) > zThresh) {
                            row._anomalies.push({ col, type: 'z', val });
                            totalAnomalies++;
                        } else if (Math.abs(val - mean) > sdThresh*stdDev) {
                            row._anomalies.push({ col, type: 'sd', val });
                            totalAnomalies++;
                        }
                    });
                }

                // 2. Categorical Analysis
                if(type === 'string') {
                    const counts = {};
                    values.forEach(v => counts[v] = (counts[v]||0) + 1);
                    const entries = Object.entries(counts).sort((a,b) => b[1] - a[1]); // Sort desc
                    categoricalStats[col] = { unique: entries.length, top: entries.slice(0, 5), counts };
                }
            });

            updateOverview(totalAnomalies);
            renderNumericalGrid();
            renderCategoricalGrid();
            setupGroupingUI();
            setupTimeUI();
            renderTable();
        }

        function updateOverview(anomCount) {
            getEl('sumRows').textContent = rawData.length.toLocaleString();
            getEl('sumCols').textContent = headers.length;
            const rowsWithAnom = rawData.filter(r => r._anomalies.length > 0).length;
            getEl('sumRate').textContent = ((rowsWithAnom / rawData.length) * 100).toFixed(1) + "%";
        }

        // --- RENDERING TABS ---

        // 1. Numerical
        function renderNumericalGrid() {
            const grid = getEl('numericGrid');
            grid.innerHTML = '';
            Object.keys(stats).forEach(col => {
                const s = stats[col];
                grid.innerHTML += `
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <span class="badge badge-num">NUM</span> ${col}
                            </div>
                            <button class="btn btn-primary" style="width:auto; padding:0.25rem 0.5rem; font-size:2rem;" onclick="showViz('${col}')"> visualize</button>
                        </div>
                        <div class="stat-body">
                            <div class="stat-row"><span>Mean</span><b>${s.mean.toFixed(2)}</b></div>
                            <div class="stat-row"><span>Median</span><b>${s.median.toFixed(2)}</b></div>
                            <div class="stat-row"><span>StdDev</span><b>${s.stdDev.toFixed(2)}</b></div>
                            <div class="stat-row"><span>Min</span><b>${s.min}</b></div>
                            <div class="stat-row"><span>Max</span><b>${s.max}</b></div>
                        </div>
                    </div>`;
            });
        }

        // 2. Categorical
        function renderCategoricalGrid() {
            const grid = getEl('categoricalGrid');
            grid.innerHTML = '';
            Object.keys(categoricalStats).forEach(col => {
                const s = categoricalStats[col];
                const total = rawData.length; // Approximate for bar width
                const bars = s.top.map(([key, count]) => {
                    const pct = (count / total) * 100;
                    return `
                    <div class="cat-bar-container">
                        <div class="cat-label" title="${key}">${key}</div>
                        <div class="cat-bar-bg"><div class="cat-bar-fill" style="width:${pct}%"></div></div>
                        <div class="cat-count">${count}</div>
                    </div>`;
                }).join('');

                grid.innerHTML += `
                    <div class="stat-card">
                        <div class="stat-header">
                            <div><span class="badge badge-cat">TXT</span> ${col}</div>
                            <small>${s.unique} Unique</small>
                        </div>
                        <div class="stat-body">${bars}</div>
                    </div>`;
            });
        }

        // 3. Time Series
        function setupTimeUI() {
            const dateCols = Object.keys(colTypes).filter(c => colTypes[c] === 'date');
            const select = getEl('timeColSelect');
            select.innerHTML = '<option value="">Select Date Column</option>';
            
            if(dateCols.length === 0) {
                getEl('noTimeMsg').classList.remove('hidden');
                getEl('timeChart').classList.add('hidden');
            } else {
                getEl('noTimeMsg').classList.add('hidden');
                getEl('timeChart').classList.remove('hidden');
                dateCols.forEach(c => select.innerHTML += `<option value="${c}">${c}</option>`);
                // Auto select first
                select.value = dateCols[0];
                renderTimeChart();
            }
        }

        function renderTimeChart() {
            const col = getEl('timeColSelect').value;
            if(!col) return;

            // Simple aggregation: Count per day
            const timeMap = {};
            rawData.forEach(r => {
                const dStr = r[col];
                if(!dStr) return;
                const d = new Date(dStr).toISOString().split('T')[0]; // YYYY-MM-DD
                timeMap[d] = (timeMap[d] || 0) + 1;
            });

            const sortedDates = Object.keys(timeMap).sort();
            const dataPoints = sortedDates.map(d => ({ x: d, y: timeMap[d] }));

            const ctx = getEl('timeChart').getContext('2d');
            if(charts.time) charts.time.destroy();

            charts.time = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Records per Day',
                        data: dataPoints,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { type: 'time', time: { unit: 'day' } }
                    }
                }
            });
        }

        // 3b. Grouping Logic
        function setupGroupingUI() {
            const groupSel = getEl('groupCol');
            const aggSel = getEl('aggCol');
            groupSel.innerHTML = ''; aggSel.innerHTML = '';

            Object.keys(colTypes).forEach(c => {
                if(colTypes[c] === 'string' || colTypes[c] === 'date') groupSel.innerHTML += `<option value="${c}">${c}</option>`;
                if(colTypes[c] === 'number') aggSel.innerHTML += `<option value="${c}">${c}</option>`;
            });
        }

        function calculateGroup() {
            const gCol = getEl('groupCol').value;
            const aCol = getEl('aggCol').value;
            const op = getEl('aggOp').value;
            
            if(!gCol || !aCol) return alert("Select columns");

            const groups = {};
            rawData.forEach(r => {
                const k = r[gCol] || "(Empty)";
                const v = r[aCol];
                if(typeof v !== 'number') return;
                if(!groups[k]) groups[k] = [];
                groups[k].push(v);
            });

            let results = Object.entries(groups).map(([key, vals]) => {
                let res = 0;
                if(op === 'sum') res = vals.reduce((a,b)=>a+b,0);
                else if(op === 'avg') res = vals.reduce((a,b)=>a+b,0) / vals.length;
                else if(op === 'count') res = vals.length;
                else if(op === 'min') res = Math.min(...vals);
                else if(op === 'max') res = Math.max(...vals);
                return { key, res };
            });

            results.sort((a,b) => b.res - a.res); // Sort descending

            getEl('aggResultContainer').classList.remove('hidden');
            getEl('aggBody').innerHTML = results.map(r => `<tr><td>${r.key}</td><td>${r.res.toLocaleString(undefined, {maximumFractionDigits:2})}</td></tr>`).join('');
        }

        // 4. Data Explorer (Table)
        function renderTable() {
            const viewMode = getEl('viewMode').value;
            let data = rawData;

            // 1. Filter by Anomalies
            if(viewMode === 'anomalies') {
                data = data.filter(r => r._anomalies.length > 0);
            }

            // 2. Filter by User Filters
            if(activeFilters.length > 0) {
                data = data.filter(row => {
                    return activeFilters.every(f => {
                        const val = row[f.col];
                        if(val == null) return false;
                        if(colTypes[f.col] === 'number') {
                            const num = parseFloat(f.val);
                            if(isNaN(num)) return true;
                            if(f.op === '>') return val > num;
                            if(f.op === '<') return val < num;
                            if(f.op === '=') return val === num;
                        } else {
                            return String(val).toLowerCase().includes(f.val.toLowerCase());
                        }
                        return true;
                    });
                });
            }

            // Render
            getEl('tableHead').innerHTML = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
            getEl('tableBody').innerHTML = data.slice(0, 200).map(r => {
                let cls = '';
                if(r._anomalies.some(a=>a.type==='z')) cls = 'anomaly-z';
                else if(r._anomalies.some(a=>a.type==='sd')) cls = 'anomaly-sd';
                return `<tr class="${cls}">${headers.map(h => `<td>${r[h]}</td>`).join('')}</tr>`;
            }).join('');
            
            getEl('rowCountDisplay').textContent = `Showing ${Math.min(200, data.length)} of ${data.length} rows`;
        }

        // --- FILTERING ---
        function addFilter() {
            activeFilters.push({ id: Date.now(), col: headers[0], op: 'contains', val: '' });
            renderFilters();
        }
        function renderFilters() {
            getEl('activeFilters').innerHTML = activeFilters.map(f => `
                <div style="background:white; border:1px solid var(--border); padding:0.5rem; border-radius:4px; display:flex; gap:0.5rem; align-items:center;">
                    <select onchange="updateFilter(${f.id}, 'col', this.value)">${headers.map(h=>`<option value="${h}" ${f.col===h?'selected':''}>${h}</option>`).join('')}</select>
                    <select onchange="updateFilter(${f.id}, 'op', this.value)">
                        <option value="contains">contains</option>
                        <option value=">">></option><option value="<"><</option><option value="=">=</option>
                    </select>
                    <input type="text" value="${f.val}" oninput="updateFilter(${f.id}, 'val', this.value)" style="width:80px; padding:0.25rem;">
                    <button onclick="removeFilter(${f.id})" style="color:red; background:none; border:none; cursor:pointer;">&times;</button>
                </div>
            `).join('');
        }
        function updateFilter(id, k, v) { activeFilters.find(x=>x.id===id)[k]=v; renderTable(); }
        function removeFilter(id) { activeFilters = activeFilters.filter(x=>x.id!==id); renderFilters(); renderTable(); }

        // --- EXPORT ---
        function downloadCSV(mode) {
            let data = rawData;
            if(mode === 'anomalies') data = rawData.filter(r => r._anomalies.length > 0);
            const clean = data.map(({_anomalies, ...rest}) => rest);
            const csv = Papa.unparse(clean);
            const blob = new Blob([csv], {type:'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `export_${mode}.csv`;
            a.click();
        }

        // --- VISUALIZATION MODAL ---
        function showViz(col) {
            getEl('vizModal').classList.remove('hidden');
            getEl('vizTitle').textContent = `Analysis: ${col}`;
            const s = stats[col];
            
            // Hist
            const ctx1 = getEl('histCanvas').getContext('2d');
            if(charts.hist) charts.hist.destroy();
            
            const bins = 20;
            const binSize = (s.max - s.min)/bins;
            const dataBins = new Array(bins).fill(0);
            const labels = new Array(bins).fill(0).map((_,i) => (s.min + i*binSize).toFixed(1));
            
            s.values.forEach(v => {
                let idx = Math.floor((v - s.min)/binSize);
                if(idx >= bins) idx = bins-1;
                dataBins[idx]++;
            });

            charts.hist = new Chart(ctx1, {
                type: 'bar',
                data: { labels, datasets: [{ label: 'Frequency', data: dataBins, backgroundColor: '#6366f1' }] }
            });

            // Box
            const ctx2 = getEl('boxCanvas').getContext('2d');
            if(charts.box) charts.box.destroy();
            charts.box = new Chart(ctx2, {
                type: 'boxplot',
                data: { labels: [col], datasets: [{ label: col, data: [s.values], backgroundColor: 'rgba(99,102,241,0.5)', borderColor:'#4338ca' }] }
            });
        }
    </script>
</body>
</html>
